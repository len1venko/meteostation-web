<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset='UTF-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>
  <title>–°—Ç–æ—Ä—ñ–Ω–∫–∞ –∑ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–º</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f3f3f3; color: #333; }
    .container { max-width: 800px; margin: 50px auto; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); text-align: center; }
    .title { font-size: 24px; font-weight: bold; margin-bottom: 20px; }
    .card { display: flex; align-items: center; justify-content: space-between; background: #f9f9f9; padding: 15px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); }
    .icon { font-size: 30px; margin-right: 20px; }
    .text { flex: 1; text-align: left; font-size: 18px; font-weight: 500; }
    .value { font-size: 18px; font-weight: bold; color: #333; }
  </style>

  <link rel="stylesheet" href="/pac.css">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">

    <!-- FullCalendar -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
    const calendarEl = document.getElementById('calendar');
    let calendar = null;
    let existingEvents = {};  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –ø–æ –¥–∞—Ç–µ

    // –§—É–Ω–∫—Ü–∏—è: –≤—ã–±–∏—Ä–∞–µ–º –Ω–∞–∏–≤—ã—Å—à–∏–π —É—Ä–æ–≤–µ–Ω—å –≥–∞–∑–∞
    const getPriorityLevel = (levels) => {
      if (levels.includes('üö® –û–ø–∞—Å–Ω—ã–π –≥–∞–∑')) return 'üö® –û–ø–∞—Å–Ω—ã–π –≥–∞–∑';
      if (levels.includes('‚ö†Ô∏è –°—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å –≥–∞–∑–∞')) return '‚ö†Ô∏è –°—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å –≥–∞–∑–∞';
      return '‚úÖ –ù–æ—Ä–º–∞';
    };

    const fetchAndUpdateCalendar = () => {
      fetch('https://script.google.com/macros/s/AKfycbz5DH-UVC3OJGBq_cwbqnHYcQ8yQrNXM3-5Eae46Lg5RiIN2RJkpU4L8D49dAnMRME5/exec')
        .then(response => response.json())
        .then(data => {
          let dateLevels = {};  // { '2025-03-19': ['‚úÖ –ù–æ—Ä–º–∞', 'üö® –û–ø–∞—Å–Ω—ã–π –≥–∞–∑', ...], ... }

          data.forEach(item => {
            const gasLevel = parseFloat(item.gasValue);
            const date = item.timestamp.split('T')[0];

            let level = '‚úÖ –ì–∞–∑ –Ω–µ –±—É–ª–æ –∑–∞—Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ';
            if (gasLevel > 400) level = 'üö® –ë—É–ª–æ –∑–∞—Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ –Ω–µ–±–µ–∑–ø–µ—á–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≥–∞–∑—É';
            else if (gasLevel > 300) level = '‚ö†Ô∏è –ë—É–ª–æ –∑–∞—Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ –Ω–µ–∑–Ω–∞—á–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≥–∞–∑—É';

            if (!dateLevels[date]) dateLevels[date] = [];
            dateLevels[date].push(level);
          });

          let newEvents = [];

          for (let date in dateLevels) {
            if (existingEvents[date]) continue;  // –£–∂–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ —Å–æ–±—ã—Ç–∏–µ ‚Äî –Ω–µ –º–µ–Ω—è–µ–º

            const priorityLevel = getPriorityLevel(dateLevels[date]);
            existingEvents[date] = priorityLevel;

            newEvents.push({
              title: priorityLevel,
              start: date + 'T00:00:00',
              end: date + 'T23:59:59',
              allDay: true
            });
          }

          // –û–±—ä–µ–¥–∏–Ω—è–µ–º —Å—Ç–∞—Ä—ã–µ –∏ –Ω–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è
          const allEvents = Object.entries(existingEvents).map(([date, title]) => ({
            title,
            start: date + 'T00:00:00',
            end: date + 'T23:59:59',
            allDay: true
          }));

          // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω
          if (!calendar) {
            calendar = new FullCalendar.Calendar(calendarEl, {
              initialView: 'dayGridMonth',
              events: allEvents,
              eventContent: function(info) {
                return { html: info.event.title };
              },
              eventClassNames: ['no-highlight'],
              dateClick: function(info) {
                fetchDailyData(info.dateStr);  // –≤—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –¥–µ–Ω—å
              }
            });
            calendar.render();
          } else {
            calendar.removeAllEvents();
            calendar.addEventSource(allEvents);
          }
        })
        .catch(err => {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', err);
        });
    };
    

    // –ü–µ—Ä–≤–∏—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
    fetchAndUpdateCalendar();

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥, –Ω–æ –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è
    setInterval(fetchAndUpdateCalendar, 10000);

    function fetchDailyData(dateStr) {
    fetch('https://script.google.com/macros/s/AKfycbz5DH-UVC3OJGBq_cwbqnHYcQ8yQrNXM3-5Eae46Lg5RiIN2RJkpU4L8D49dAnMRME5/exec')
      .then(response => response.json())
      .then(data => {
        let filtered = data.filter(item => item.timestamp.startsWith(dateStr));

        if (filtered.length === 0) {
          alert("–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –∑–∞ " + dateStr);
          return;
        }

        let tempSum = 0, humSum = 0, pressSum = 0, altSum = 0, gasSum = 0;

        filtered.forEach(item => {
          tempSum += parseFloat(item.temperature);
          humSum += parseFloat(item.humidity);
          pressSum += parseFloat(item.pressure);
          altSum += parseFloat(item.altitude);
          gasSum += parseFloat(item.gasValue);
        });

        let count = filtered.length;

        let avgTemp = (tempSum / count).toFixed(2);
        let avgHum = (humSum / count).toFixed(2);
        let avgPress = (pressSum / count).toFixed(2);
        let avgAlt = (altSum / count).toFixed(2);
        let avgGas = (gasSum / count).toFixed(2);

        alert(
          `–°–µ—Ä–µ–¥–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è –∑–∞ ${dateStr}:\n` +
          `üå° –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: ${avgTemp} ¬∞C\n` +
          `üíß –í–æ–ª–æ–≥—ñ—Å—Ç—å: ${avgHum} %\n` +
          `üí® –¢–∏—Å–∫: ${avgPress} hPa\n` +
          `‚õ∞ –í–∏—Å–æ—Ç–∞: ${avgAlt} m\n` +
          `üõ¢ –ì–∞–∑: ${avgGas} ppm`
        );
      })
      .catch(err => {
        console.error('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö:', err);
      });
  }
    });

  </script>  


  <div class='container'>
    <div class='title'>–ö–∞–ª–µ–Ω–¥–∞—Ä –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ –≥–∞–∑—É</div> <br>
  <div id="calendar"></div>
</div>

<button style="display: flex; margin-bottom: 25px; margin-left: 15px;" class="button" onclick="window.location.href='/'">–ü–µ—Ä–µ—Ö—ñ–¥ –¥–æ –≥–æ–ª–æ–≤–Ω–æ—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏</button>

</body>
</html>