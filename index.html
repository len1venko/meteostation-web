<!DOCTYPE HTML>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta charset="UTF-8">
  <title>–°—Ç–æ—Ä—ñ–Ω–∫–∞ –∑ –≥—Ä–∞—Ñ—ñ–∫–∞–º–∏</title>
  <script src="https://code.highcharts.com/stock/highstock.js"></script> <!-- –∏–∑–º–µ–Ω–µ–Ω–æ -->
  <link rel="stylesheet" href="/pac.css">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f3f3f3; color: #333; }
    .container { max-width: 800px; margin: 50px auto; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); text-align: center; }
    h2 { font-family: Arial; font-size: 2.5rem; text-align: center; }
  </style>
</head>
<body>

<h2>–°–∏—Å—Ç–µ–º–∞ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É –ø–æ–≤—ñ—Ç—Ä—è –π–æ—É</h2>
<div id="chart-temperature" class="container"></div>
<div id="chart-humidity" class="container"></div>
<div id="chart-pressure" class="container"></div>
<div id="chart-altitude" class="container"></div>
<div id="chart-gasvalue" class="container"></div>

<button style="display: flex; margin-bottom: 25px; margin-left: 15px;" class="button" onclick="window.location.href='/'">–ü–µ—Ä–µ—Ö—ñ–¥ –¥–æ –≥–æ–ª–æ–≤–Ω–æ—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏</button>

<script>
Highcharts.setOptions({
  time: {
    useUTC: false  // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤—Ä–µ–º—è –ø–æ –ª–æ–∫–∞–ª—å–Ω–æ–º—É —á–∞—Å–æ–≤–æ–º—É –ø–æ—è—Å—É
  }
});

const GAS_URL = 'https://script.google.com/macros/s/AKfycbz5DH-UVC3OJGBq_cwbqnHYcQ8yQrNXM3-5Eae46Lg5RiIN2RJkpU4L8D49dAnMRME5/exec';

function createChart(containerId, titleText, yAxisText, seriesColor) {
  return new Highcharts.StockChart({
    chart: { renderTo: containerId },
    title: { text: titleText },
    rangeSelector: {
      buttons: [
        { count: 1, type: 'day', text: '1–¥' },
        { count: 7, type: 'day', text: '7–¥' },
        { count: 1, type: 'month', text: '1–º—ñ—Å' },
        { type: 'all', text: '–í—Å–µ' }
      ],
      selected: 0
    },
    series: [{
      showInLegend: false,
      data: [],
      tooltip: { valueDecimals: 2 }
    }],
    plotOptions: {
      line: {
        animation: false,
        dataLabels: { enabled: true }
      },
      series: { color: seriesColor }
    },
    yAxis: { title: { text: yAxisText } },
    credits: { enabled: false }
  });
}

// –°–æ–∑–¥–∞—ë–º –≤—Å–µ –≥—Ä–∞—Ñ–∏–∫–∏
const chartT = createChart('chart-temperature', '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞', '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (¬∞C)', '#059e8a');
const chartH = createChart('chart-humidity', '–í–æ–ª–æ–≥—ñ—Å—Ç—å', '–í–æ–ª–æ–≥—ñ—Å—Ç—å (%)', '#1E90FF');
const chartP = createChart('chart-pressure', '–ê—Ç–º–æ—Å—Ñ–µ—Ä–Ω–∏–π —Ç–∏—Å–∫', '–ê—Ç–º–æ—Å—Ñ–µ—Ä–Ω–∏–π —Ç–∏—Å–∫ (hPa)', '#32CD32');
const chartA = createChart('chart-altitude', '–í–∏—Å–æ—Ç–∞ –Ω–∞–¥ —Ä—ñ–≤–Ω–µ–º –º–æ—Ä—è', '–í–∏—Å–æ—Ç–∞ –Ω–∞–¥ —Ä—ñ–≤–Ω–µ–º –º–æ—Ä—è (m)', '#FFA500');
const chartG = createChart('chart-gasvalue', '–°—É–∫—É–ø–Ω—ñ—Å—Ç—å –≥–∞–∑—ñ–≤ —É –ø–æ–≤—ñ—Ç—Ä—ñ', '–°—É–∫—É–ø–Ω—ñ—Å—Ç—å –≥–∞–∑—ñ–≤ —É –ø–æ–≤—ñ—Ç—Ä—ñ (ppm)', '#DC143C');

// –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑ Google –¢–∞–±–ª–∏—Ü—ã
fetch(GAS_URL)
  .then(response => response.json())
  .then(data => {
    const formattedT = [], formattedH = [], formattedP = [], formattedA = [], formattedG = [];
    data.forEach(entry => {
      const time = new Date(entry.timestamp).getTime();
      formattedT.push([time, parseFloat(entry.temperature)]);
      formattedH.push([time, parseFloat(entry.humidity)]);
      formattedP.push([time, parseFloat(entry.pressure)]);
      formattedA.push([time, parseFloat(entry.altitude)]);
      formattedG.push([time, parseFloat(entry.gasValue)]);
    });
    chartT.series[0].setData(formattedT);
    chartH.series[0].setData(formattedH);
    chartP.series[0].setData(formattedP);
    chartA.series[0].setData(formattedA);
    chartG.series[0].setData(formattedG);
  })
  .catch(error => {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Google –¢–∞–±–ª–∏—Ü—ã:', error);
  });

// üîπ –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
function setupLiveUpdate(endpoint, chart) {
  setInterval(() => {
    fetch(endpoint)
      .then(response => response.text())
      .then(valueStr => {
        const x = (new Date()).getTime();
        const y = parseFloat(valueStr);
        if (chart.series[0].data.length > 50) {
          chart.series[0].addPoint([x, y], true, true, true);
        } else {
          chart.series[0].addPoint([x, y], true, false, true);
        }
      })
      .catch(error => {
        console.error(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å ${endpoint}:`, error);
      });
  }, 10000);
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–ª—è –≤—Å–µ—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤
setupLiveUpdate('/temperature', chartT);
setupLiveUpdate('/humidity', chartH);
setupLiveUpdate('/pressure', chartP);
setupLiveUpdate('/altitude', chartA);
setupLiveUpdate('/gasvalue', chartG);
</script>

</body>
</html>
